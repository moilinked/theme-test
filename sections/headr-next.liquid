{% comment %} *CSS* {% endcomment %}
<link rel="stylesheet" href="{{ 'component-search.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-menu-drawer.css' | asset_url }}" media="print" onload="this.media='all'">

<style>
  .header-wrapper {
    z-index: 70;
    position: relative;
  }
  .header-content {
    width: 100%;
    height: 72px;
    display: flex;
    align-items: center;
    padding: 0 var(--spacing-margin-desktop);
  }
  .header-logo {
    display: flex;
    width: max-content;
    height: max-content;
    align-items: center;
    justify-content: center;
  }
  .header-menu-wrapper {
    flex: 1;
    width: 100%;
    height: 100%;
    display: flex;
  }
  .header-menu-nav {
    width: 100%;
    height: 100%;
  }
  .header-menu-list {
    margin: 0;
    padding: 0;
    height: 100%;
    display: flex;
    list-style: none;
    align-items: center;
    justify-content: center;
  }
  .header-menu-item {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0px 16px;
    height: 100%;
  }
  .header-menu-item:hover .header-menu-jump-link {
    color: var(--color-text-highlight);
  }
  .header-menu-jump-link {
    height: 100%;
    align-content: center;
    color: var(--color-text-primary);
    text-decoration: none;
  }
  .header-content-right {
    gap: 12px;
    display: flex;
    position: relative;
    align-items: center;
  }
  .header-content-right-item {
    display: flex;
    cursor: pointer;
    position: relative;
    align-items: center;
    justify-content: center;
  }
  .header-content-right-item .svg-wrapper {
    width: 20px;
    height: 20px;
    color: #111111;
  }
  .cart-count-badge {
    top: 0;
    right: 0;
    width: 22px;
    color: #fff;
    height: 22px;
    display: flex;
    position: absolute;
    translate: 50% -30%;
    border-radius: 22px;
    align-items: center;
    justify-content: center;
    background-color: #00caff;
  }
</style>

{%- style -%}
{%- endstyle -%}
<style>
  .header__submenu {
    position: absolute;
    top: 100%;
    left: 0;
    background: #fff;
    min-width: 200px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: 0.2s ease;
  }
  .header-menu-item {
    position: relative;
  }
  .header-menu-item.header-menu-item-full-screen {
    position: static;
  }
  /* 打开状态 */
  [data-open='true'] > .header__submenu,
  [data-open='true'] > .mega-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  .full-screen {
    width: 100%;
  }

  .mega-menu {
    position: absolute;
    inset: 100% 0 auto 0;
    background: #fff;
    box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
    opacity: 0;
    visibility: hidden;
    transition: 0.25s ease;
    opacity: 1;
    visibility: visible;
  }

  /* hover 打开 */
  .has-mega:hover > .mega-menu,
  .has-mega:focus-within > .mega-menu {
    opacity: 1;
    visibility: visible;
  }

  /* 三列布局 */
  .mega-menu__grid {
    display: grid;
    grid-template-columns: 240px 240px 1fr;
    min-height: 420px;
  }

  /* 默认隐藏 */
  .lvl2-group,
  .product-list {
    display: none;
  }

  /* 激活态 */
  .lvl2-group[data-active='true'],
  .product-list[data-active='true'] {
    display: block;
  }

  /* hover 高亮 */
  .lvl1-item:hover,
  .lvl2-item:hover {
    background: #f5f5f5;
  }
</style>

{% comment %} *Layout* {% endcomment %}
{{ shop.metafields.custom.header_product_mega_menu }}
<shop-header class="header-wrapper">
  <header class="header">
    <div class="header-content">
      {% comment %}
        {%- if settings.logo != blank -%}
          <a href='{{ routes.root_url }}' class='header-logo' aria-label='{{ shop.name }}'>
            {% render 'component-image', image: settings.logo, width: 140, height: 34, width_plus: 5 %}
          </a>
        {%- endif -%}
      {% endcomment %}
      <div class="header-logo">LOGO</div>
      <header-menu class="header-menu-wrapper">
        <nav class="header-menu-nav" aria-label="MegaMenu">
          <ul class="header-menu-list">
            {%- for block in section.blocks -%}
              {%- liquid
                assign full_screen_menu = false
                case block.type
                  when 'link_menu'
                    assign first_link = block.settings.menu.links | first
                    if first_link.links != blank
                      assign full_screen_menu = true
                    endif
                  when 'product_menu'
                    assign full_screen_menu = true
                  when 'image_text_menu'
                    assign full_screen_menu = true
                endcase
              -%}
              <li
                role="none"
                data-menu-item
                data-type="{{ block.type }}"
                class="header-menu-item {% if full_screen_menu %}header-menu-item-full-screen{% endif %}"
              >
                {%- case block.type -%}
                  {%- when 'product_menu' -%}
                    <button
                      class="header__menu-item list-menu__item link focus-inset"
                      aria-haspopup="true"
                      aria-expanded="false"
                      aria-controls="{{ block.settings.title }}"
                    >
                      {{ block.settings.title }}
                    </button>
                    <div class="mega-menu" id="{{ block.settings.title }}">
                      <div class="mega-menu__grid" data-mega-panel>
                        <!-- 左：一级 -->
                        <ul class="mega-menu__level1">
                          {%- for menu_1 in shop.metafields.custom.header_product_mega_menu.value limit: 10 -%}
                            {%- assign level_index = forloop.index -%}
                            <li>
                              <button
                                class="lvl1-item"
                                aria-expanded="false"
                                data-level="{{ level_index }}"
                              >
                                {{ menu_1.title }} => {{ level_index }}
                              </button>
                            </li>
                            {%- if menu_1.children != blank -%}
                              {%- for menu_2 in menu_1.children limit: 10 -%}
                                {{ menu_2.title }}
                              {%- endfor -%}
                            {%- endif -%}
                          {%- endfor -%}
                        </ul>
                      </div>
                    </div>
                  {%- when 'link_menu' -%}
                    <button
                      class="header__menu-item list-menu__item link focus-inset"
                      aria-haspopup="true"
                      aria-expanded="false"
                    >
                      {{ block.settings.menu.title | default: '' }}
                    </button>
                    {%- if block.settings.menu != blank and block.settings.menu.links != blank -%}
                      <ul class="header__submenu list-menu {% if full_screen_menu %}full-screen{% endif %}" role="menu">
                        {%- for link_1 in block.settings.menu.links -%}
                          {%- if link_1.links != blank -%}
                            {%- assign link_level = 2 -%}
                          {%- endif -%}
                          {{ link_level }}
                          <li role="none">
                            <a
                              href="{{ link_1.url }}"
                              class="list-menu__item link"
                              role="menuitem"
                              tabindex="-1"
                            >
                              {{ link_1.title }}
                            </a>
                          </li>
                        {%- endfor -%}
                      </ul>
                    {%- endif -%}
                  {%- when 'image_text_menu' -%}
                    <div>{{ block.settings.title }}</div>
                  {%- when 'jump_menu' -%}
                    {% assign url = block.settings.url | split: '?' | first | replace: request.origin, '' %}
                    <a
                      class="header-menu-jump-link"
                      href="{{ block.settings.url }}"
                      {% if request.path == url %}
                        aria-current="page"
                      {% endif %}
                    >
                      {{ block.settings.title }}
                    </a>
                {%- endcase -%}
              </li>
            {%- endfor -%}
          </ul>
        </nav>
      </header-menu>
      <div class="header-content-right" id="country-selector">
        {% comment %} - 国家/地区选择器 - {% endcomment %}
        {%- if section.settings.enable_country_selector -%}
          <div class="header-content-right-item">国家/地区选择器</div>
        {%- endif -%}

        {% comment %} - 搜索 - {% endcomment %}
        <div class="header-content-right-item">
          <span class="svg-wrapper">
            {{- 'icon-search.svg' | inline_asset_content -}}
          </span>
        </div>

        {% comment %} - 用户信息 - {% endcomment %}
        {%- if shop.customer_accounts_enabled -%}
          <account-drawer class="header-content-right-item" rel="nofollow">
            <span class="svg-wrapper">{{ 'icon-account.svg' | inline_asset_content }}</span>
            <span class="visually-hidden">
              {%- if customer -%}
                Account
              {%- else -%}
                Log in
              {%- endif -%}
            </span>
          </account-drawer>
        {%- endif -%}

        {%- for block in section.blocks -%}
          {%- case block.type -%}
            {%- when '@app' -%}
              {% render block %}
          {%- endcase -%}
        {%- endfor -%}

        {% comment %} - 购物车 - {% endcomment %}
        <div class="header-content-right-item" id="cart-icon-bubble">
          <span class="svg-wrapper">{{- 'icon-cart.svg' | inline_asset_content -}}</span>
          <span class="visually-hidden">Cart</span>
          {%- if cart != empty -%}
            <div class="cart-count-badge">
              {%- if cart.item_count < 100 -%}
                <span aria-hidden="true">{{ cart.item_count }}</span>
              {%- endif -%}
              <span class="visually-hidden">
                {%- if cart.item_count == 1 -%}1 item{% else %}{{ cart.item_count }} items{% endif -%}
              </span>
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>
  </header>
</shop-header>

<script>
  class ShopHeader extends HTMLElement {
    delay = 120;
    closeDelay = 180;
    timer = null;

    connectedCallback() {
      this.items = this.querySelectorAll('[data-menu-item]');
      this.bindEvents();
    }

    bindEvents() {
      this.items.forEach((item) => {
        const trigger = item.querySelector('button');
        if (!trigger) return;

        item.addEventListener('mouseenter', () => {
          this.open(item);
        });

        item.addEventListener('mouseleave', () => {
          this.close(item);
        });

        trigger.addEventListener('focus', () => {
          this.open(item);
        });

        trigger.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            this.close(item);
            trigger.focus();
          }
        });
      });
    }

    scheduleOpen(item) {
      clearTimeout(this.timer);
      this.timer = setTimeout(() => this.open(item), this.delay);
    }

    scheduleClose(item) {
      clearTimeout(this.timer);
      this.timer = setTimeout(() => this.close(item), this.closeDelay);
    }

    open(item) {
      this.closeAll();
      item.dataset.open = 'true';
      const btn = item.querySelector('button');
      btn?.setAttribute('aria-expanded', 'true');

      item.querySelectorAll('a').forEach((a) => (a.tabIndex = 0));
    }

    close(item) {
      delete item.dataset.open;
      const btn = item.querySelector('button');
      btn?.setAttribute('aria-expanded', 'false');

      item.querySelectorAll('a').forEach((a) => (a.tabIndex = -1));
    }

    closeAll() {
      this.items.forEach((item) => this.close(item));
    }
  }

  customElements.define('shop-header', ShopHeader);

  class MegaMenu {
    constructor(root) {
      this.root = root;
      this.lvl1Items = root.querySelectorAll('.lvl1-item');
      this.lvl2Items = root.querySelectorAll('.lvl2-item');

      this.bind();
    }

    bind() {
      this.lvl1Items.forEach((btn) => {
        btn.addEventListener('mouseenter', () => {
          this.activateLevel1(btn.dataset.lvl1);
        });

        btn.addEventListener('focus', () => {
          this.activateLevel1(btn.dataset.lvl1);
        });
      });

      this.lvl2Items.forEach((btn) => {
        btn.addEventListener('mouseenter', () => {
          const lvl1 = btn.closest('[data-lvl1]').dataset.lvl1;
          this.activateLevel2(lvl1, btn.dataset.lvl2);
        });
      });
    }

    activateLevel1(index) {
      this.root.querySelectorAll('.lvl2-group').forEach((el) => {
        el.dataset.active = el.dataset.lvl1 === index;
      });

      this.root.querySelectorAll('.product-list').forEach((el) => {
        el.dataset.active = 'false';
      });
    }

    activateLevel2(lvl1, lvl2) {
      this.root.querySelectorAll('.product-list').forEach((el) => {
        el.dataset.active = el.dataset.lvl1 === lvl1 && el.dataset.lvl2 === lvl2;
      });
    }
  }

  document.querySelectorAll('.mega-menu').forEach((menu) => {
    new MegaMenu(menu);
  });
</script>

{% comment %} *Schema* {% endcomment %}
{% schema %}
{
  "name": "导航栏",
  "class": "section-header",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo 图片",
      "info": "建议图片压缩至 500 KB 以内"
    },
    {
      "type": "header",
      "content": "导航栏右侧内容"
    },
    {
      "type": "checkbox",
      "id": "enable_country_selector",
      "default": true,
      "label": "展示国家/地区选择器"
    },
    {
      "type": "checkbox",
      "id": "enable_customer_avatar",
      "default": true,
      "label": "展示用户信息"
    }
  ],
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "product_menu",
      "name": "产品菜单",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "标题"
        }
      ]
    },
    {
      "type": "link_menu",
      "name": "链接集合菜单",
      "settings": [
        { "type": "link_list", "id": "menu", "label": "链接集合" },
        {
          "type": "select",
          "id": "popup_type",
          "label": "弹出样式",
          "default": "min-width",
          "options": [
            { "value": "min-width", "label": "最小宽度" },
            { "value": "full_screen", "label": "占满屏幕" }
          ]
        }
      ]
    },
    {
      "type": "image_text_menu",
      "name": "图文卡片菜单",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "标题"
        }
      ]
    },
    {
      "type": "jump_menu",
      "name": "跳转菜单",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "标题"
        },
        {
          "type": "url",
          "id": "url",
          "label": "跳转链接"
        }
      ]
    }
  ]
}
{% endschema %}
